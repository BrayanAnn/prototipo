<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>App Inspetor - OS</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f4f6f9;
        color: #333;
      }
      header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: rgba(0, 119, 204, 0.85);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: white;
        padding: 15px;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        z-index: 1000;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }
      main {
        padding: 80px 15px 80px;
      }
      section {
        display: none;
      }
      section.active {
        display: block;
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .card h3 {
        margin: 0 0 8px;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 6px;
        color: #0077cc;
      }
      .card p {
        margin: 4px 0;
        font-size: 14px;
      }
      .city-images,
      .os-images {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }
      .city-images img,
      .os-images img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
      }
      .city-images img:hover,
      .os-images img:hover {
        transform: scale(1.05);
      }
      .map {
        margin: 10px 0 0 0;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        width: 100%;
        background: #e0e0e0;
      }
      .actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .actions button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s, transform 0.2s;
      }
      .actions .approve {
        background: #4caf50;
        color: #fff;
      }
      .actions .approve:hover {
        background: #43a047;
      }
      .actions .deny {
        background: #f44336;
        color: #fff;
      }
      .actions .deny:hover {
        background: #c62828;
      }
      nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        display: flex;
        justify-content: space-around;
        border-top: 1px solid rgba(200, 200, 200, 0.5);
        padding: 8px 0;
        z-index: 1000;
      }
      nav button {
        flex: 1;
        background: none;
        border: none;
        padding: 6px;
        text-align: center;
        font-size: 12px;
        color: #666;
        cursor: pointer;
      }
      nav button i {
        font-size: 18px;
        display: block;
        margin-bottom: 4px;
      }
      nav button.active {
        color: #0077cc;
        font-weight: bold;
      }
      @media (max-width: 480px) {
        .card h3 {
          font-size: 15px;
        }
        .actions button {
          font-size: 14px;
          padding: 10px;
        }
      }
    </style>
  </head>
  <body>
    <header>App Inspetor</header>
    <main>
      <!-- Rotas -->
      <section id="rotas" class="active">
        <div class="card">
          <h3><i class="fa-solid fa-route"></i> Mapa</h3>
          <div
            id="map"
            style="
              width: 100%;
              height: 300px;
              margin-bottom: 15px;
              border-radius: 10px;
            "
          ></div>
        </div>
        <div class="card">
          <h3><i class="fa-solid fa-route"></i> Rotas de OS</h3>
          <p>
            Selecione uma ordem de serviço para visualizar detalhes e
            aprovar ou negar.
          </p>
          <div id="os-list"></div>
        </div>
      </section>
      <!-- Detalhes -->
      <section id="detalhes">
        <div class="card" id="os-detalhes"></div>
      </section>
      <!-- Aprovadas -->
      <section id="aprovadas">
        <div class="card">
          <h3><i class="fa-solid fa-check"></i> OS Aprovadas</h3>
          <div id="os-aprovadas-list"></div>
        </div>
      </section>
    </main>
    <nav>
      <button onclick="mostrarPagina('rotas')" class="active">
        <i class="fa-solid fa-map"></i>
        Rotas
      </button>
      <button onclick="mostrarPagina('aprovadas')">
        <i class="fa-solid fa-list-check"></i>
        Aprovadas
      </button>
    </nav>
    <script>
      // Dados simulados de OS
      const ordens = [
        {
          id: 5,
          status: 'pendente',
          descricao: 'Buraco na rua',
          fotos: ['cidade1.jpg'],
          coordenadas: '-23.55, -46.63',
          mapa: 'cidade1.jpg',
        },
        {
          id: 6,
          status: 'pendente',
          descricao: 'Vazamento de água',
          fotos: ['cidade2.jpg'],
          coordenadas: '-23.56, -46.64',
          mapa: 'cidade2.jpg',
        },
        {
          id: 7,
          status: 'aprovada',
          descricao: 'Árvore caída',
          fotos: ['cidade3.jpg'],
          coordenadas: '-23.57, -46.65',
          mapa: 'cidade3.jpg',
        },
      ];
      let selected = null;

      function renderOSList() {
        const osList = document.getElementById('os-list');
        osList.innerHTML = '';
        ordens
          .filter((os) => os.status === 'pendente')
          .forEach((os) => {
            const div = document.createElement('div');
            div.className = 'card';
            div.style.cursor = 'pointer';
            div.innerHTML = `<b>OS ${os.id}</b> - ${os.descricao}<br><span style='font-size:13px;color:#888;'>${os.coordenadas}</span>`;
            div.onclick = () => {
              if (
                window.map &&
                typeof map.centralizarOS === 'function'
              ) {
                map.centralizarOS(os);
              }
              selected = os;
              mostrarPagina('detalhes');
              renderOSDetalhes();
            };
            osList.appendChild(div);
          });
        if (osList.innerHTML === '')
          osList.innerHTML =
            '<p style="color:#888;">Nenhuma OS pendente.</p>';
        // Garante mapa renderizado apenas se a seção rotas está ativa e visível
        const rotasSection = document.getElementById('rotas');
        if (
          rotasSection &&
          rotasSection.classList.contains('active') &&
          document.getElementById('map')
        ) {
          setTimeout(() => inicializarMapaOL(), 0);
        }
      }

      function renderOSDetalhes() {
        const detalhes = document.getElementById('os-detalhes');
        if (!selected) {
          detalhes.innerHTML = '<p>Selecione uma OS.</p>';
          return;
        }
        detalhes.innerHTML = `
                <h3><i class="fa-solid fa-file-alt"></i> OS ${
                  selected.id
                }</h3>
                <p><b>Descrição:</b> ${selected.descricao}</p>
                <div class="os-images">
                    ${selected.fotos
                      .map(
                        (f) => `<img src="assets/${f}" alt="foto">`
                      )
                      .join('')}
                </div>
                <p><b>Coordenadas:</b> ${selected.coordenadas}</p>
                ${
                  selected.status === 'pendente'
                    ? `
                <div class="actions">
                    <button class="approve" onclick="aprovarOS(${selected.id})"><i class='fa-solid fa-check'></i> Aprovar</button>
                    <button class="deny" onclick="negarOS(${selected.id})"><i class='fa-solid fa-xmark'></i> Negar</button>
                </div>`
                    : ''
                }
                <div style="margin-top:10px;"><button onclick="mostrarPagina('rotas')" style="background:#eee;color:#0077cc;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;"><i class='fa-solid fa-arrow-left'></i> Voltar</button></div>
            `;
        // Esconde popup do mapa se existir
        const popupEl = document.getElementById('ol-popup');
        if (popupEl) popupEl.style.display = 'none';
      }
      // --- OpenLayers MAPA ---
      let map, vectorSource, overlay;
      let popupOverlay;
      function inicializarMapaOL() {
        if (map) {
          map.setTarget(null);
          map = null;
        }
        // Cria features das OS
        const features = ordens.map((os) => {
          const coords = os.coordenadas
            .split(',')
            .map((s) => parseFloat(s.trim()));
          return new ol.Feature({
            geometry: new ol.geom.Point(
              ol.proj.fromLonLat([coords[1], coords[0]])
            ),
            osData: os,
          });
        });
        function styleFunction(feature) {
          const os = feature.get('osData');
          let color = '#ff9800';
          if (os.status === 'aprovada') color = '#4caf50';
          return new ol.style.Style({
            image: new ol.style.Circle({
              radius: 7,
              fill: new ol.style.Fill({ color }),
              stroke: new ol.style.Stroke({
                color: 'white',
                width: 2,
              }),
            }),
          });
        }
        vectorSource = new ol.source.Vector({ features });
        const vectorLayer = new ol.layer.Vector({
          source: vectorSource,
          style: styleFunction,
        });
        map = new ol.Map({
          target: 'map',
          layers: [
            new ol.layer.Tile({ source: new ol.source.OSM() }),
            vectorLayer,
          ],
          view: new ol.View({
            center: ol.proj.fromLonLat([-46.64, -23.56]),
            zoom: 13,
          }),
        });
        // Popup customizado
        let popupEl = document.getElementById('ol-popup');
        if (!popupEl) {
          popupEl = document.createElement('div');
          popupEl.id = 'ol-popup';
          popupEl.style.position = 'absolute';
          popupEl.style.background = 'white';
          popupEl.style.padding = '10px 16px';
          popupEl.style.borderRadius = '10px';
          popupEl.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
          popupEl.style.border = '1px solid #ccc';
          popupEl.style.minWidth = '180px';
          popupEl.style.pointerEvents = 'auto';
          popupEl.style.display = 'none';
          popupEl.innerHTML =
            '<span id="ol-popup-close" style="position:absolute;top:4px;right:10px;cursor:pointer;font-size:16px;color:#888;">&times;</span><div id="ol-popup-content"></div>';
          document.body.appendChild(popupEl);
        }
        popupOverlay = new ol.Overlay({
          element: popupEl,
          autoPan: { animation: { duration: 250 } },
        });
        map.addOverlay(popupOverlay);
        document.getElementById('ol-popup-close').onclick =
          function () {
            popupOverlay.setPosition(undefined);
            popupEl.style.display = 'none';
          };
        // Clique no marcador
        map.on('singleclick', function (evt) {
          const feature = map.forEachFeatureAtPixel(
            evt.pixel,
            (f) => f
          );
          if (feature) {
            const os = feature.get('osData');
            const coord = feature.getGeometry().getCoordinates();
            document.getElementById(
              'ol-popup-content'
            ).innerHTML = `<b>OS ${os.id}</b><br>${os.descricao}<br><span style='font-size:12px;color:#888;'>${os.coordenadas}</span>`;
            popupOverlay.setPosition(coord);
            popupEl.style.display = 'block';
          } else {
            popupOverlay.setPosition(undefined);
            popupEl.style.display = 'none';
          }
        });
        // Fecha popup ao clicar fora
        map.on('movestart', function () {
          popupOverlay.setPosition(undefined);
          popupEl.style.display = 'none';
        });
        // Permite centralizar e abrir popup via função
        map.centralizarOS = function (os) {
          const coords = os.coordenadas
            .split(',')
            .map((s) => parseFloat(s.trim()));
          const coord = ol.proj.fromLonLat([coords[1], coords[0]]);
          map.getView().setCenter(coord);
          map.getView().setZoom(16);
          // Busca feature
          const feature = vectorSource.getFeatures().find((f) => {
            const c = f.getGeometry().getCoordinates();
            return c[0] === coord[0] && c[1] === coord[1];
          });
          if (feature) {
            document.getElementById(
              'ol-popup-content'
            ).innerHTML = `<b>OS ${os.id}</b><br>${os.descricao}<br><span style='font-size:12px;color:#888;'>${os.coordenadas}</span>`;
            popupOverlay.setPosition(coord);
            popupEl.style.display = 'block';
          }
        };
      }

      function renderOSAprovadas() {
        const aprovadas = document.getElementById(
          'os-aprovadas-list'
        );
        aprovadas.innerHTML = '';
        ordens
          .filter((os) => os.status === 'aprovada')
          .forEach((os) => {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `<b>OS ${os.id}</b> - ${os.descricao}<br><span style='font-size:13px;color:#888;'>${os.coordenadas}</span>`;
            aprovadas.appendChild(div);
          });
        if (aprovadas.innerHTML === '')
          aprovadas.innerHTML =
            '<p style="color:#888;">Nenhuma OS aprovada.</p>';
      }

      window.aprovarOS = function (id) {
        const os = ordens.find((o) => o.id === id);
        ordens
          .filter((os) => os.status === 'aprovada')
          .forEach((os) => {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `<b>OS ${os.id}</b> - ${os.descricao}<br><span style='font-size:13px;color:#888;'>${os.coordenadas}</span>`;
            aprovadas.appendChild(div);
          });
        if (aprovadas.innerHTML === '')
          aprovadas.innerHTML =
            '<p style="color:#888;">Nenhuma OS aprovada.</p>';
      };

      window.aprovarOS = function (id) {
        const os = ordens.find((o) => o.id === id);
        if (os) os.status = 'aprovada';
        selected = null;
        mostrarPagina('rotas');
        renderOSList();
        renderOSAprovadas();
      };
      window.negarOS = function (id) {
        const idx = ordens.findIndex((o) => o.id === id);
        if (idx !== -1) ordens.splice(idx, 1);
        selected = null;
        mostrarPagina('rotas');
        renderOSList();
        renderOSAprovadas();
      };

      function mostrarPagina(pagina) {
        document
          .querySelectorAll('section')
          .forEach((sec) => sec.classList.remove('active'));
        document.getElementById(pagina).classList.add('active');
        document
          .querySelectorAll('nav button')
          .forEach((btn) => btn.classList.remove('active'));
        if (pagina === 'rotas')
          document
            .querySelectorAll('nav button')[0]
            .classList.add('active');
        if (pagina === 'aprovadas')
          document
            .querySelectorAll('nav button')[1]
            .classList.add('active');
        if (pagina === 'rotas') {
          renderOSList();
        }
        if (pagina === 'aprovadas') renderOSAprovadas();
        if (pagina === 'detalhes') renderOSDetalhes();
      }

      // Inicialização
      renderOSList();
      renderOSAprovadas();
    </script>
  </body>
</html>
